# MeasureFit

## 简介

MeasureFit 是一个大地测量数据处理库，包括数据预处理，数据平差等功能。

### 特色
* 模型有很强的鲁棒性，可以同时输入多种观测，或约束条件。
* Python 语言实现，具有强大而灵活的io能力，成果渲染能力。
* 提供了一种多站极坐标融合成前方交会的高效，便捷算法。
* 没有使用任何数据结构，面向对象概念，全部基于python基础数据类型实现。

（暂无概略坐标计算功能，因为光电测量已经普及，多数情况下是有概略坐标的）

## 功能模块

### 平差模块
测量数据平差是大地测量中的核心任务之一，MeasureFit 提供了一个通用，鲁棒的平差模型：

* **支持多种观测**：水准观测，夹角观测，方向观测，距离观测，并支持多种观测的任意组合。
* **精度分析**：能够输出平差坐标，及精度分析，给出点位精度，以及各个观测量的平差精度。
* **成果输出**：能够输出json成果，txt报表，绘制图形。
* **支持条件约束**：支持含有已知高程，夹角，方向，距离的条件平差。
* **支持序贯求解**：支持观测量逐一纳入，采用卡尔曼滤波方式求解。

### 数据预处理
数据预处理是确保测量数据质量的关键步骤，MeasureFit 提供了以下功能来进行数据预处理：

* **加乘常数，气象改正**：可以对观测数据进行加乘常数改正，气象ppm改正。
* **球气差改正**：斜距转换高差平距的时候，可以进行球气差改正。
* **平距投影高程改正**：可以将平距投影到给定水准面上，做投影改正。

## 数据格式
measurefit 是完全面向过程的，没有任何自定义数据结构，类，全部采用python的基础容器实现。非常简单，高效。可以和json，yaml进行导入导出。

### 点数据
```python
points = [
    ('A', 8986.68, 5705.03, 0, True),
    ('B', 13737.37, 10501.92, 0, True),
    ('C', 6642.27, 14711.75, 0, True),
    ('D', 10122.12, 10312.47, 0, False)
]
```
点数据用一个python的tuple或list，分别是 Name, X, Y, H, Type。Type表示是否是已知点。


### 观测数据
```python
measures = [
    ('ang', 'B', 'A', 'E', 1.58635, None),  
    ('station', 'B', None),  
    ('dir', 'B', 'E', 0.221017, None),
    ('dist', 'D', 'C', 6523.643, None),
    ('lev', 'A', 'B', 12.75, None)
]
```

观测数据分多种，同样用一个tuple或list表示。
* **角度**：**[ang, p1, p2, p3, value, sta]**
* **测站**：**[station, name, h0]** 测站无需观测值，但携带了一个自由定向角，所以在方向观测之前，必须插入一个station记录。h0 是测站高程（概略即可），主要是用于做投影高程改正，如无需改正可给None。
* **方向**：**[dir, p1, p2, value, sta]**
* **平距**：**[dist, p1, p2, value, sta]**
* **水准**：**[lev, p1, p2, value, sta]**

**备注**：
* **单位**：上述距离观测值 m 为单位，角度观测弧度为单位。测量上惯用小数点表示度分秒，我们提供了dms2rs对观测数据进行转换。

* **精度**：sta表示观测精度，中误差。距离观测 mm 为单位，角度观测 ″ 为单位，如果指定则用给定精度进行平差，填None，求解器会利用原始测角测距精度进行推导。水准观测有时也会利用距离定权，用距离定权的时候，sta请输入距离的负数，m为单位，系统会用1km作为单位权。

* 观测精度给0表示约束条件，求解器将使用拉格朗日乘数进行约束平差求解。
* 
### 扩展观测数据
```python
measures = [
    ('station', 'TN1', None),
    ('ts', 'TN1', 'TN2', 0, 0.00163, 612.41862),
    ('axhd', 'TN1', 'TN2', 0.79, 0.16, 788,90, None, None, None)
]
```
扩展观测数据不是独立直接观测量，不能直接纳入求解器。是为了简化输入，需要使用转换函数进行转换。

* **全站仪观测**：**[ts, p1, p2, ax, ay, l]** 
* **方向高差平距观测**：**[axhd, ax, h, d dax, dh, d]** 

**转换方法**：  
* **ts2ahds** 函数将 **ts** 观测转换为 **axhd** 观测，这个过程中观测精度将自动计算并传播给 **axhd** 观测。
* **splitmeas** 将 **axhd** 观测分解为 **dir**, **lev**, **dist** 观测，进而求解。

### 结算点位成果
```python
rst = [('Px', 999.8374, 577.3316, 100.0019, False, 3.06, -0.65, -0.65, 1.45, 6.29)]
```
**成果点位数据**：**[Name, X, Y, H, Type, Dxx, Dxy, Dyx, Dyy, Dhh]** 后面分别是平面协方差以及高差方差。携带协方差信息，可以方便的计算点位精度，长短轴，以及多站同点成果融合。
